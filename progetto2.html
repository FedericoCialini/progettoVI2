<!DOCTYPE html>
<html>
<head>
	<title>progetto2</title>
	<meta charset="utf-8">
	<script type="text/javascript" src="d3/d3.min.js"></script>
</head>
<body>
	<script type="text/javascript">

	const workarea_width = 1600;
	const workarea_height = 900;
	const workarea_center_x = workarea_width/2;
	const workarea_center_y = workarea_height/2;
	var coordinateMap = new Map();
    
    //--------------------------//
    
    var container = d3.select("body")
		.append("svg")
		.attr("width", workarea_width).attr("height", workarea_height)
        //.attr("viewBox", "0 0 "+workarea_width+" "+workarea_height)
        //.attr("preserveAspectRatio", "xMidYMid meet")
        .attr("style", "outline: medium solid black;")
        .call(d3.zoom().on("zoom", function () {
            workarea.attr("transform", d3.event.transform);
        }))
        .on("dblclick.zoom", null);
        
	var workarea = container.append("g");
        
    function resize_container() {
        container.attr("width", window.innerWidth-20).attr("height", window.innerHeight-20);
    }
        
    resize_container();
        
    window.addEventListener("resize", resize_container);
        
    //--------------------------//

	var graph = [];
	d3.json("graph.json").then(function(data) {
		console.log(data);
		graph[0] = data;
		console.log(graph);
		workarea.selectAll(".rect")
			.data(data)
			.enter()
			.append("rect")
			.attr("id","0")
			.attr("x", workarea_center_x)
			.attr("y", workarea_center_y)
			.attr("rx", 10)
			.attr("ry", 10)
			.attr("width", 50)
			.attr("height", 50)
			.attr("fill", "red")
			.attr("stroke-width", 2)
			.attr("stroke", "black")
			.on("click", explode);
			k=workarea_center_x+","+workarea_center_y;
			coordinateMap.set(k,{id:"0",x:workarea_center_x,y:workarea_center_y});
		});

	function retrieveElementFromGraphByPathId(path){//path as to be list: [0,1,0]
		var i = 0;
		var g = graph[0];
		while (path[i]!=null) {
			if(path.length==i+1){
				return g[path[i]];
			}
			else {
				g = g[path[i]];
				i=i+1;
			}
		}
		return null;
	}

	function idStringToList(string){
		var i = 0;
		var list = [];
		var buffer = "";
		while (string[i]!=null){
			if(string[i]!=","){
				buffer = buffer + string[i]
			}
			else {
				list.push(buffer);
				buffer = "";
			}
			i=i+1;
		}
		list.push(buffer);
		return list;
	}

	//default map.set delete the old record and overwrite it with the new one, this one is here just in case
	function mapInsertWithNoOverwrite(k,v){
		if(coordinateMap.has(k)){
			console.log("già c'è");
		}
		else {
			coordinateMap.set(k,v);
		}
	}

	function info(){
		console.log(this.attributes.id.value+";"+this.attributes.x.value+","+this.attributes.y.value+";"+this.attributes.info.value);
	}

	function explode(event){
		console.log(this.attributes.id.value+";"+this.attributes.x.value+","+this.attributes.y.value);
		var fatherid =this.attributes.id.value;
		var fatherxy = this.attributes.x.value+this.attributes.y.value;
		var listid = idStringToList(fatherid);
		var a = retrieveElementFromGraphByPathId(listid);
		a.forEach(function(d, i) {
			var xy = assignCoordinates();
			console.log(d + " " + i);
			if(d[i]!=null){
				workarea
					.append("rect")
					.attr("id",fatherid+","+i)
					.attr("fatherid",fatherid)
					.attr("x", xy.x)
					.attr("y", xy.y)
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("width", 50)
					.attr("height", 50)
					.attr("fill", "red")
					.attr("stroke-width", 2)
					.attr("stroke", "black")
					.on("click", explode);
			}
			else {
				workarea
					.append("rect")
					.attr("id",fatherid+","+i)
					.attr("fatherid",fatherid)
					.attr("info", d)
					.attr("x", xy.x)
					.attr("y", xy.y)
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("width", 50)
					.attr("height", 50)
					.attr("fill", "red")
					.attr("stroke-width", 2)
					.attr("stroke", "black")
					.on("click", info);
			}
			var k = xy.x+","+xy.y;
			coordinateMap.set(k,{id:fatherid+i,x:xy.x,y:xy.y});
			});
		workarea.select("[id='"+fatherid+"']").remove();
		coordinateMap.delete(fatherxy);
	}

	function assignCoordinates(){
		//console.log(Math.floor(Math.random() * 1601));//from 0 to 1600
		//console.log(Math.floor(Math.random() * 901));//from 0 to 900
		while(true){
			var x = Math.floor(Math.random() * 1601);
			var y = Math.floor(Math.random() * 901);
			var k =x+","+y;
			if(coordinateMap.has(k)==false){
				return {x:x,y:y};
			}
		}
	}

	</script>
</body>
</html>