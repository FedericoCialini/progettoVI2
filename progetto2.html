<!DOCTYPE html>
<html>
<head>
	<title>progetto2</title>
	<meta charset="utf-8">
	<script type="text/javascript" src="d3/d3.min.js"></script>
</head>
<body>
	<script type="text/javascript">

	const workarea_width = 1600;
	const workarea_height = 900;
	const workarea_center_x = workarea_width/2;
	const workarea_center_y = workarea_height/2;
        
	const distance = 100;
    const cluster_rect_width = 60;
    const cluster_rect_height = 60;
    const node_circle_r = 20;  // -> diameter is 2*r
    
    //--------------------------//
    
    var container = d3.select("body")
		.append("svg")
		.attr("width", workarea_width).attr("height", workarea_height)
        .attr("style", "outline: medium solid black;")
        .call(d3.zoom().on("zoom", function () {
            workarea.attr("transform", d3.event.transform);
        }))
        .on("dblclick.zoom", null);
        
	var workarea = container.append("g");
        
    function resize_container() {
        container.attr("width", window.innerWidth-20).attr("height", window.innerHeight-20);
    }
        
    resize_container();
        
    window.addEventListener("resize", resize_container);
        
    //--------------------------//
        
    function getRandomIntInRange(min, max) {
        min = Math.ceil(min);
        max = Math.ceil(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
        
    function generateIntArrayWithRange(start, end) {
        var array = [];
        for(var i=start; i<=end; i++) {
            array.push(i);
        }
        return array;
    }
        
    function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;

        while (0 !== currentIndex) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
        }

        return array;
    }
        
    //--------------------------//
        
    // classes do exist in javascript! (it's just syntactic sugar though)
    // this class represent a logical plane, through which we're going to display a cluster's elements
    class Plane {

        constructor(this_node, parent_node, element_list) {
            this.node = this_node;
            this.parent = parent_node;  //parent_node is the actual display object representing the parent node (the workarea for the root plane)
            this.numberOfElements = element_list.length;
            this.elements = element_list;
            this.elementCoords = this.generateElementsCoords();
        }
        
        generateElementsCoords() {
            var element2coords = [];
            var Xcoords = shuffle(generateIntArrayWithRange(1,this.numberOfElements));
            var Ycoords = shuffle(generateIntArrayWithRange(1,this.numberOfElements));
            for(var i=0; i<this.numberOfElements; i++) {
                var x = Xcoords[i];
                var y = Ycoords[i];
                element2coords[i] = [x,y];
            }
            return element2coords;
        }
        
        displayChildren() {
            var thisId = this.node.attributes.id.value;
            var x = this.node.attributes.x.value;
            var y = this.node.attributes.y.value;

            this.elements.forEach(function(d, i) {
                console.log(d + " " + i);
                if(d[0]!=null){
                    this.parent
                        .append("rect")
                        .attr("id",thisId+","+i)
                        .attr("class","cluster_node")
                        .attr("parentId",thisId)
                        .attr("x", parseInt(parseInt(x) + parseInt(this.elementCoords[i][0])*distance))
                        .attr("y", parseInt(parseInt(y) + parseInt(this.elementCoords[i][1])*distance))
                        .attr("rx", 10)
                        .attr("ry", 10)
                        .attr("width", cluster_rect_width)
                        .attr("height", cluster_rect_height)
                        .attr("fill", "red")
                        .attr("stroke-width", 2)
                        .attr("stroke", "black")
                        .on("click", explode);
                }
                else {
                    this.parent
                        .append("circle")
                        .attr("id",thisId+","+i)
                        .attr("class","node")
                        .attr("parentId",thisId)
                        .attr("info", d)
                        .attr("cx", parseInt(parseInt(x)+parseInt(this.elementCoords[i][0])*distance))
                        .attr("cy", parseInt(parseInt(y)+parseInt(this.elementCoords[i][1])*distance))
                        .attr("r", node_circle_r)
                        .attr("fill", "green")
                        .attr("stroke-width", 2)
                        .attr("stroke", "black")
                        .on("click", info);
                }
            }, this);
        }
        
        displayBackgroundCluster() {
            var thisId = this.node.attributes.id.value;
            var x = this.node.attributes.x.value;
            var y = this.node.attributes.y.value;
            this.parent
                .append("rect")
                .attr("id",thisId)
                .attr("class","cluster_bg")
                .attr("x",x)
                .attr("y",y)
                .attr("rx", 10)
                .attr("ry", 10)
                .attr("width", this.elementCoords.length*distance)
                .attr("height", this.elementCoords.length*distance)
                .attr("fill", "blue")
                .attr("fill-opacity",0.2)
                .attr("stroke-width", 2)
                .attr("stroke", "black")
        }
        
        displayPlane() {
            // if this is the root cluster node
            if(this.parent === workarea) {
                this.displayChildren()
                
            // if this is NOT the root cluster node
            } else {
                this.displayBackgroundCluster();
                this.displayChildren();
            }
        }
        
        hidePlane() {
            // TODO
        }
        
    }
        
    //--------------------------//

	
	var graph = [];
	d3.json("clusters.json").then(function(data) {
		console.log(data);
		graph[0] = data;
		console.log(graph);
		workarea.selectAll(".rect")
			.data(data)
			.enter()
            .append("g")
            .attr("id",0)
            .attr("class","plane")
            .attr("x", workarea_center_x)
			.attr("y", workarea_center_y)
        var thisId = "0";
		var thisIdAsPath = [0];
		var thisJsonSubtree = retrieveElementFromGraphByPathId(thisIdAsPath);
        var this_node = workarea.select("[id='"+thisId+"']")._groups[0][0];
        var parent_node = workarea;
		var plane = new Plane(this_node,parent_node,thisJsonSubtree);
		plane.displayPlane();
    });

	function retrieveElementFromGraphByPathId(path){   //path as to be list: [0,1,0]
		var i = 0;
		var g = graph[0];
		while (path[i]!=null) {
			if(path.length==i+1){
				return g[path[i]];
			}
			else {
				g = g[path[i]];
				i=i+1;
			}
		}
		return null;
	}

	function idStringToList(string){
		var i = 0;
		var list = [];
		var buffer = "";
		while (string[i]!=null){
			if(string[i]!=","){
				buffer = buffer + string[i]
			}
			else {
				list.push(buffer);
				buffer = "";
			}
			i=i+1;
		}
		list.push(buffer);
		return list;
	}

	function info(){
		console.log(this.attributes.id.value+";"+this.attributes.x.value+","+this.attributes.y.value+";"+this.attributes.info.value);
	}

	function explode(event){
		var thisId = this.attributes.id.value;
		var thisIdAsPath = idStringToList(thisId);
		var thisJsonSubtree = retrieveElementFromGraphByPathId(thisIdAsPath);
        var parentId = this.attributes.parentId.value;
        var parent_node = workarea.select("[id='"+parentId+"']");
		var plane = new Plane(this,parent_node,thisJsonSubtree);
		plane.displayPlane();
        workarea.select("[id='"+thisId+"'].cluster_node").remove();
	}

	function assignCoordinates(){
		//console.log(Math.floor(Math.random() * 1601));//from 0 to 1600
		//console.log(Math.floor(Math.random() * 901));//from 0 to 900
		while(true){
			var x = Math.floor(Math.random() * 1601);
			var y = Math.floor(Math.random() * 901);
			var k =x+","+y;
			return {x:x,y:y};	
		}
	}

	</script>
</body>
</html>