<!DOCTYPE html>
<html>
<head>
	<title>progetto2</title>
	<meta charset="utf-8">
	<script type="text/javascript" src="d3/d3.min.js"></script>
</head>
<body>
	<script type="text/javascript">

	const workarea_width = 1600;
	const workarea_height = 900;
	const workarea_center_x = workarea_width/2;
	const workarea_center_y = workarea_height/2;
	const distance = 50;
    
    //--------------------------//
    
    var container = d3.select("body")
		.append("svg")
		.attr("width", workarea_width).attr("height", workarea_height)
        .attr("style", "outline: medium solid black;")
        .call(d3.zoom().on("zoom", function () {
            workarea.attr("transform", d3.event.transform);
        }))
        .on("dblclick.zoom", null);
        
	var workarea = container.append("g");
        
    function resize_container() {
        container.attr("width", window.innerWidth-20).attr("height", window.innerHeight-20);
    }
        
    resize_container();
        
    window.addEventListener("resize", resize_container);
        
    //--------------------------//
        
    function getRandomIntInRange(min, max) {
        min = Math.ceil(min);
        max = Math.ceil(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
        
    function generateIntArrayWithRange(start, end) {
        var array = [];
        for(var i=start; i<=end; i++) {
            array.push(i);
        }
        return array;
    }
        
    function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;

        while (0 !== currentIndex) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
        }

        return array;
    }
        
    //--------------------------//
        
    // classes do exist in javascript! (it's just syntactic sugar though)
    // this class represent a logical plane, through which we're going to display a cluster's elements
    class Plane {

        constructor(parent_node, element_list) {
            this.parent = parent_node;  //parent_node is the actual display object representing the parent node (the workarea for the root plane)
            console.log(this.parent);
            this.numberOfElements = element_list.length;
            console.log(this.numberOfElements);
            this.elements = element_list;
            console.log(this.elements);
            this.elementCoords = this.generateElementsCoords();
            console.log(this.elementCoords);
        }



        /*get elements() {
            return this.elements;
        }*/



        generateElementsCoords() {
            var element2coords = [];
            var Xcoords = shuffle(generateIntArrayWithRange(1,this.numberOfElements));
            var Ycoords = shuffle(generateIntArrayWithRange(1,this.numberOfElements));
            for(var i=0; i<this.numberOfElements; i++) {
                var x = Xcoords[i];
                var y = Ycoords[i];
                element2coords[i] = [x,y];
            }
            return element2coords;
        }
        
        displayPlane() {
            // WIP
            var fatherid = this.parent.attributes.id.value;
            console.log(fatherid);
            console.log(this.parent.attributes.x.value+","+this.parent.attributes.y.value);
            var x = this.parent.attributes.x.value;
            var y = this.parent.attributes.y.value;
            var copy = this.elementCoords;
            console.log(copy);
            console.log(x);
            console.log(y);
            workarea
            	.append("rect")
            	.attr("id",fatherid)
            	.attr("x",x)
            	.attr("y",y)
            	.attr("rx", 10)
				.attr("ry", 10)
				.attr("width", this.elementCoords.length*100)
				.attr("height", this.elementCoords.length*100)
				.attr("fill", "blue")
				.attr("fill-opacity",0.2)
				.attr("stroke-width", 2)
				.attr("stroke", "black")
            this.elements.forEach(function(d, i) {
			//var xy = assignCoordinates();
			console.log(d + " " + i);
			if(d[0]!=null){
				workarea
					.append("rect")
					.attr("id",fatherid+","+i)
					.attr("fatherid",fatherid)
					.attr("x", parseInt(parseInt(x) + parseInt(copy[i][0])*distance))
					.attr("y", parseInt(parseInt(y) + parseInt(copy[i][1])*distance))
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("width", 50)
					.attr("height", 50)
					.attr("fill", "red")
					.attr("stroke-width", 2)
					.attr("stroke", "black")
					.on("click", explode);
			}
			else {
				workarea
					.append("circle")
					.attr("id",fatherid+","+i)
					.attr("fatherid",fatherid)
					.attr("info", d)
					.attr("cx", parseInt(parseInt(x)+parseInt(copy[i][0])*distance))
					.attr("cy", parseInt(parseInt(y)+parseInt(copy[i][1])*distance))
					.attr("r", 25)
					.attr("fill", "green")
					.attr("stroke-width", 2)
					.attr("stroke", "black")
					.on("click", info);
			}
			});
        }
        
        hidePlane() {
            // WIP
        }
        
    }
        
    //--------------------------//

	
	var graph = [];
	d3.json("clusters.json").then(function(data) {
		console.log(data);
		graph[0] = data;
		console.log(graph);
		workarea.selectAll(".rect")
			.data(data)
			.enter()
			.append("rect")
			.attr("id","0")
			.attr("x", workarea_center_x)
			.attr("y", workarea_center_y)
			.attr("rx", 10)
			.attr("ry", 10)
			.attr("width", 50)
			.attr("height", 50)
			.attr("fill", "red")
			.attr("stroke-width", 2)
			.attr("stroke", "black")
			.on("click", explode);
		});

	function retrieveElementFromGraphByPathId(path){   //path as to be list: [0,1,0]
		var i = 0;
		var g = graph[0];
		while (path[i]!=null) {
			if(path.length==i+1){
				return g[path[i]];
			}
			else {
				g = g[path[i]];
				i=i+1;
			}
		}
		return null;
	}

	function idStringToList(string){
		var i = 0;
		var list = [];
		var buffer = "";
		while (string[i]!=null){
			if(string[i]!=","){
				buffer = buffer + string[i]
			}
			else {
				list.push(buffer);
				buffer = "";
			}
			i=i+1;
		}
		list.push(buffer);
		return list;
	}

	function info(){
		console.log(this.attributes.id.value+";"+this.attributes.x.value+","+this.attributes.y.value+";"+this.attributes.info.value);
	}

	function explode(event){
		console.log(this.attributes.id.value+";"+this.attributes.x.value+","+this.attributes.y.value);
		var fatherid = this.attributes.id.value;
		var listid = idStringToList(fatherid);
		var a = retrieveElementFromGraphByPathId(listid);
		console.log(this);
		console.log(a);
		var plane = new Plane(this,a);
		plane.displayPlane();
		workarea.select("[id='"+fatherid+"']").remove();
	}

	function assignCoordinates(){
		//console.log(Math.floor(Math.random() * 1601));//from 0 to 1600
		//console.log(Math.floor(Math.random() * 901));//from 0 to 900
		while(true){
			var x = Math.floor(Math.random() * 1601);
			var y = Math.floor(Math.random() * 901);
			var k =x+","+y;
			return {x:x,y:y};	
		}
	}

	</script>
</body>
</html>